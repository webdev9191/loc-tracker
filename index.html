<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBH4_DTpvk4OlZ3JY85p6fB9wwJ8YKRU0&callback=initMap&v=weekly"
      async
      defer
    ></script>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="map" style="height: 400px; width: 100%"></div>
    <br />
    <div id="speed"></div>
    <br />
    <div id="accuracy"></div>
    <br />
    <br />
    <div id="details"></div>
    <br />
    <br />
    <div id="circular-buffer"></div>
    <br> <br>
    <div id="totalDistance"></div>

    <script>
      var reqcount = 0;
      var map;
      var position;
      var marker;

      var prevPosition = null;
      var totalDistance = 0;

      // წინა გრძედ განედების დასაქეშად
      //   var latLongsArray = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -34.397, lng: 150.644 }, // Initial
          zoom: 17,
        });

        marker = new google.maps.Circle({
          strokeColor: "#0000FF",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#0000FF",
          fillOpacity: 0.4,
          radius: 5,
          map: map,
        });

        const successCallback = (pos) => {
          reqcount++;

          const { accuracy, latitude, longitude, speed } = pos.coords;

          const speedDiv = document.getElementById("speed");
          speedDiv.innerHTML = "Speed: " + speed.toFixed(10) + " [m/s]";

          const accuracyDiv = document.getElementById("accuracy");
          accuracyDiv.innerHTML =
            "Accuracy: " + accuracy.toFixed(2) + ` მეტრ რადიუსით ზუსტი)`;

          // წინაპირობა გამოთვლების დასაწყებად: მინიმუმ ამდენი მ/წ უნდა იყოს სიჩქარე
          const walking_speed = 0.2;

          if (speed > walking_speed) {
            position = {
              lat: latitude,
              lng: longitude,
            };

            if (prevPosition) {
              const totalDistanceDiv = document.getElementById("totalDistance");

              //   latLongsArray.push([position, prevPosition]);
              //   console.log(latLongsArray);

              class CircularBuffer {
                constructor(size) {
                  this.buffer = new Array(size).fill(null);
                  this.size = size;
                  this.head = 0; // points to the next position to be replaced
                }

                addItem(item) {
                  this.buffer[this.head] = item;
                  this.head = (this.head + 1) % this.size;
                }

                getBuffer() {
                  return this.buffer;
                }
              }

              const bufferSize = 5;
              const circularBuffer = new CircularBuffer(bufferSize);

              circularBuffer.addItem([position, prevPosition]);
              console.log("Current buffer:", circularBuffer.getBuffer());

              const circularBufferDiv = document.getElementById("circular-buffer")
              circularBufferDiv.innerHTML = circularBuffer.getBuffer().toString()
            }

            // თუ არარი prevPosition მაშინ აწი იქნება და შემდეგ successCallbackზე გამოთვლის მანძილს
            prevPosition = {
              lat: latitude,
              lng: longitude,
            };

            map.setCenter(position);
            marker.setCenter(position);
            marker.setRadius(accuracy);

            // ყველაფერი რო მორჩება საიტზე რო გამოსახოს მაგის კოდია ეს
            details.innerHTML =
              `სიჩქარე მეტია ${walking_speed}-ზე, გამოთვლა დაიწყო` + "<br>";
            details.innerHTML +=
              "Latitude: " +
              latitude +
              " | " +
              "Longitude: " +
              longitude +
              "<br>";
          } else {
            details.innerHTML = `სიჩქარე ნაკლებია ${walking_speed}-ზე`
          }
        };

        // არ შვება ჯერ არაფერს
        const errorCallback = () => {};

        // მაღალი სიზუსტის პარამეტრები დოკუმენტაციის მიხედვით
        const options = {
          enableHighAccuracy: true,
          // maximumAge: 30000,
          // timeout: 5000,
        };

        navigator.geolocation.watchPosition(
          // ეს ფუნქცია იწყებს თრექინგს
          successCallback, // ლოკაციის წარმატებით მოძიების შემთხვევაში ამ ფუნქიას გაუშვებს
          errorCallback, // წარუმატებლობაზე ამ ფუნქციას
          options // ეს პარამეტრებია
        );
      }

      window.initMap = initMap;

      // FORMULAS
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the earth in km
        const dLat = deg2rad(lat2 - lat1); // deg2rad below
        const dLon = deg2rad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) *
            Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in km
        return distance;
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }
    </script>
  </body>
</html>
