<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBH4_DTpvk4OlZ3JY85p6fB9wwJ8YKRU0&callback=initMap&v=weekly"
      async
      defer
    ></script>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="map" style="height: 400px; width: 100%"></div>
    <br />
    <div id="details"></div>
    <br />
    <div id="totalDistance">Total Distance Traveled:</div>

    <script>
      var reqcount = 0;
      var map;
      var position;
      var marker;

      var prevPosition = null;
      var totalDistance = 0;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -34.397, lng: 150.644 }, // Initial
          zoom: 17,
        });

        marker = new google.maps.Circle({
          strokeColor: "#0000FF",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#0000FF",
          fillOpacity: 0.4,
          radius: 5,
          map: map,
        });

        const successCallback = (pos) => {
          const { accuracy, latitude, longitude, altitude, heading, speed } =
            pos.coords;

          reqcount++;

          position = {
            lat: latitude,
            lng: longitude,
          };

          if (prevPosition) {
            const totalDistanceDiv = document.getElementById("totalDistance");

            // Calculate distance between previous and current positions using Haversine formula
            const distance = calculateDistance(
              prevPosition.lat,
              prevPosition.lng,
              latitude,
              longitude
            );

            console.log(distance);

            totalDistance += distance;
            totalDistanceDiv.innerHTML =
              "Total Distance Traveled: " + totalDistance.toFixed(2) + " km";
          }

          prevPosition = {
            lat: latitude,
            lng: longitude,
          };

          map.setCenter(position);
          marker.setCenter(position);
          if (heading) marker.setHeading(heading);

          details.innerHTML = "Accuracy: " + accuracy + "<br>";
          details.innerHTML +=
            "Latitude: " +
            latitude +
            " | " +
            "Longitude: " +
            longitude +
            "<br>";
          details.innerHTML += "Altitude: " + altitude + "<br>";
          details.innerHTML += "Heading: " + heading + "<br>";
          details.innerHTML += "Speed: " + speed + "<br>";
        };

        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Radius of the earth in km
          const dLat = deg2rad(lat2 - lat1); // deg2rad below
          const dLon = deg2rad(lon2 - lon1);
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) *
              Math.cos(deg2rad(lat2)) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          const distance = R * c; // Distance in km
          return distance;
        }

        function deg2rad(deg) {
          return deg * (Math.PI / 180);
        }

        const errorCallback = () => {};

        const options = {
          enableHighAccuracy: true,
          maximumAge: 30000,
          timeout: 5000,
        };

        navigator.geolocation.watchPosition(
          successCallback,
          errorCallback,
          options
        );
      }

      window.initMap = initMap;
    </script>
  </body>
</html>
